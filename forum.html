<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<script>
(function(){
  try {
    var unlocked = localStorage.getItem('fire_unlocked');
    if (unlocked !== 'true' && unlocked !== true) {
      window.stop();
      window.location.replace('seal.html');
      return;
    }
    // è‹¥æœ‰å¾Œç«¯é©—è­‰ç«¯é»ï¼Œå–æ¶ˆè¨»è§£ä»¥ä¸‹ç¨‹å¼ç¢¼
    // fetch('/api/verify', {credentials:'include'}).then(function(r){
    //   if(!r.ok) throw new Error('bad');
    // }).catch(function(){ window.stop(); window.location.replace('seal.html'); });
  } catch (e) {
    window.stop();
    window.location.replace('seal.html');
  }
})();
</script>
<noscript><meta http-equiv="refresh" content="0;url=seal.html"></noscript>

<script>
  try {
    const unlocked = localStorage.getItem('fire_unlocked');
    if (unlocked !== 'true') {
      window.location.href = 'seal.html';
    }
  } catch (e) {
    window.location.href = 'seal.html';
  }
</script>


<script>
  try {
    const unlocked = localStorage.getItem('fire_unlocked');
    if (unlocked !== 'true') {
      window.location.href = 'seal.html';
    }
  } catch (e) {
    window.location.href = 'seal.html';
  }
</script>


<script>
  try {
    const unlocked = localStorage.getItem('fire_unlocked');
    if (unlocked !== 'true') {
      window.location.href = 'seal.html';
    }
  } catch (e) {
    window.location.href = 'seal.html';
  }
</script>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Forum</title>



<style>
.empty-state {
  text-align:center;
  padding:40px 20px;
  color:#777;
  font-size:1.1rem;
  border:2px dashed #ccc;
  border-radius:12px;
  margin-top:20px;
}
</style>


<style id="user-ui-override">
/* åªè¿½åŠ ï¼Œä¸è¦†è“‹ä½ çš„æ—¢æœ‰æ¨£å¼ */
.user-right{
  position: fixed !important;
  top: 12px !important;
  right: 12px !important;
  z-index: 2147483000 !important;
  display: flex !important;
  align-items: center !important;
  gap: 8px !important;
  font-family: 'æ¨™æ¥·é«”','Times New Roman',serif !important;
}
.login-text{
  color: #666 !important;
  cursor: pointer !important;
  font-size: 18px !important;
  line-height: 1 !important;
  user-select: none !important;
}
.user-menu .avatar{
  width: 40px !important;
  height: 40px !important;
  border-radius: 50% !important;
  object-fit: cover !important;
  border: 2px solid #ff7a00 !important;
  box-sizing: border-box !important;
  cursor: pointer !important;
}
#userDropdown{
  position: fixed !important;
  right: 12px !important;
  top: 64px !important;
  width: 260px !important;
  background: #fff !important;
  border: 1px solid #ddd !important;
  border-radius: 10px !important;
  box-shadow: 0 6px 18px rgba(0,0,0,.18) !important;
  padding: 14px !important;
  display: none !important;
  z-index: 2147483600 !important;
  text-align: left !important;
  font-family: 'æ¨™æ¥·é«”','Times New Roman',serif !important;
}
#userDropdown.show{ display: block !important; }
#userDropdown p{
  margin: 6px 0 !important;
  font-size: 16px !important;
  line-height: 1.6 !important;
  word-break: break-all !important;
}
#userDropdown .btn{
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 100% !important;
  height: 42px !important;
  border: none !important;
  border-radius: 10px !important;
  color: #fff !important;
  font-size: 16px !important;
  margin-top: 10px !important;
  cursor: pointer !important;
  font-family: 'æ¨™æ¥·é«”','Times New Roman',serif !important;
}
#userDropdown .edit-btn{ background: #ff7a00 !important; }
#userDropdown .logout-btn{ background: #444 !important; }
</style>


</head>
<body>
<script>
(function(){
  try {
    var unlocked = localStorage.getItem('fire_unlocked');
    if (unlocked !== 'true' && unlocked !== true) {
      window.stop();
      window.location.replace('seal.html');
    }
  } catch (e) {
    window.stop();
    window.location.replace('seal.html');
  }
})();
</script>

<div class="top-bar">
  <header>è’ºè—œå¥³å­©çš„ä½èª</header>
  <div class="user-right">
    <!-- removed user-menu
      <img alt="é ­åƒ" class="avatar" id="userAvatar" src="default-avatar.png"/>
      <div class="dropdown" id="userDropdown">
        <p id="userNickname"></p>
        <p id="userEmail"></p>
        <button class="btn" style="width:100%;padding:8px" onclick="window.location.href='data.html'">ç·¨è¼¯å€‹äººè³‡æ–™</button>
        <button class="btn" id="logoutBtn" style="background:#444;margin-top:6px;width:100%;padding:8px">ç™»å‡º</button>
      removed user-menu -->
    </div>
  </div>
</div>

<nav>
  <a href="main.html">é¦–é </a>
  <a href="intro.html">å°èªªç°¡ä»‹</a>
  <a href="preview.html">è©¦é–±</a>
  <a href="book.html">é—œæ–¼å¯¦é«”æ›¸</a>
  <a href="forum.html" class="active">è¨è«–å€</a>
  <a href="author.html">é—œæ–¼ä½œè€…</a>

  <a href="witness.html">è¦‹è­‰è€…åå†Š</a>
  <a href="seeds.html">ç«ç¨®é•·å»Š</a></nav>

<main class="container">
  <div style="text-align:right;margin-bottom:10px;">
    <button class="btn" id="newThreadBtn">ï¼‹ ç™¼è¡¨æ–°ä¸»é¡Œ</button>
  </div>
  <section class="section">
    <h2>å®˜æ–¹å…¬å‘Š</h2>
    <p>é€™è£¡æœƒé¡¯ç¤ºç®¡ç†å“¡å…¬å‘Šã€‚</p>
  </section>
  <section class="section">
    <h2>ç†±é–€è©±é¡Œ</h2>
    <p>é¡¯ç¤ºç•™è¨€æ•¸æœ€å¤šçš„å‰ä¸‰å€‹ä¸»é¡Œã€‚</p>
  </section>
  
<section class="section">
  <h2>æ‰€æœ‰ä¸»é¡Œ</h2>
  <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 12px 0;">
    <div>
      <input id="searchBox" placeholder="æœå°‹ä¸»é¡Œæˆ–ç•™è¨€â€¦" style="padding:8px 10px;border-radius:10px;border:1px solid #ddd;width:260px"/>
      <label style="margin-left:10px;font-size:.95rem"><input type="checkbox" id="tagOnly"> åªçœ‹æœ‰æ¨™ç±¤</label>
    </div>
    <div>
      æ’åºï¼š
      <select id="sortSel" style="padding:6px 10px;border-radius:8px;border:1px solid #ddd">
        <option value="latest">æœ€æ–°</option>
        <option value="likes">æŒ‰è®šæ•¸</option>
        <option value="replies">å›è¦†æ•¸</option>
      </select>
    </div>
  </div>
  <div id="topicList" class="topic-list"></div>
</section>

<section class="section" id="threadSection" style="display:none;">
  <div class="thread">
    <div class="thread-header">
      <h2 id="threadTitle" style="margin:0;"></h2>
      <span id="threadTags"></span>
      <button class="btn icon" id="followBtn" title="è¿½è¹¤æ­¤ä¸»é¡Œ"><span class="bell" id="bell">ğŸ””</span><span id="followText">è¿½è¹¤</span></button>
      <button class="btn icon" id="toggleReplies">æ”¶åˆå›è¦†</button>
    </div>
    <div id="threadMeta" class="topic-meta" style="margin:8px 0 4px 0;"></div>
    <div id="comments"></div>
    <div id="editorWrap" style="position:relative;margin-top:12px;">
      <div class="editor" id="editor">
        <div class="toolbar">
          <button class="tool-btn" data-cmd="bold"><b>B</b></button>
          <button class="tool-btn" data-cmd="italic"><i>I</i></button>
          <button class="tool-btn" data-cmd="quote">â€œå¼•ç”¨â€</button>
          <button class="tool-btn" data-cmd="code">code</button>
          <button class="tool-btn" id="emojiBtn">ğŸ˜€</button>
          <div id="emojiPanel"></div>
        </div>
        <div id="editorBox" class="editor-box" contenteditable="true" aria-label="æ’°å¯«ç•™è¨€â€¦"></div>
        <div class="editor-actions">
          <button class="btn" id="cancelQuote" style="display:none;">å–æ¶ˆå¼•ç”¨</button>
          <button class="btn" id="sendBtn">é€å‡ºç•™è¨€</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Profile modal -->
<div class="top">
      <img id="pfAvatar" src="default-avatar.png" alt="é ­åƒ">
      <div>
        <div id="pfName" style="font-weight:bold;font-size:1.2rem"></div>
        <div id="pfBio" style="font-size:.95rem;color:#555"></div>
      </div>
    </div>
    <div class="stats">
      <div>ä¸»é¡Œ <span id="pfTopics">0</span></div>
      <div>ç•™è¨€ <span id="pfComments">0</span></div>
      <div>è®š <span id="pfLikes">0</span></div>
    </div>
  </div>
</div>

</main>




<script>
(function(){
  const userStr = localStorage.getItem("user");
  if(userStr){
    const user = JSON.parse(userStr);
    const avatar = document.getElementById("userAvatar");
    if(avatar){
      avatar.src = user.avatar || "default-avatar.png";
      avatar.addEventListener("click", () => {
        const dropdown = document.getElementById("userDropdown");
        dropdown.classList.toggle("show");
      });
    }
    const nn = document.getElementById("userNickname");
    if(nn){ nn.textContent = "æš±ç¨±ï¼š" + (user.nickname || ""); }
    const em = document.getElementById("userEmail");
    if(em){ em.textContent = "Emailï¼š" + (user.email || ""); }

    const logoutBtn = document.getElementById("logoutBtn");
    if(logoutBtn){
      logoutBtn.addEventListener("click", ()=>{
        localStorage.removeItem("user");
        localStorage.removeItem("loggedIn");
        const loginBtn = document.createElement("div");
        loginBtn.className = "login";
        loginBtn.textContent = "ç™»å…¥";
        loginBtn.onclick = ()=> window.location.href = "login.html";
        const um = document.querySelector(".user-menu");
        if(um) um.replaceWith(loginBtn);
      });
    }
  } else {
    const userMenu = document.querySelector(".user-menu");
    if(userMenu){
      const loginBtn = document.createElement("div");
      loginBtn.className = "login";
      loginBtn.textContent = "ç™»å…¥";
      loginBtn.onclick = ()=> window.location.href = "login.html";
      userMenu.replaceWith(loginBtn);
    }
  }
})();
document.getElementById("newThreadBtn").addEventListener("click", function(){
  alert("ä¹‹å¾Œæœƒé–‹å•Ÿç™¼è¡¨ä¸»é¡Œè¡¨å–®");
});
</script>


<script>
(function(){
  // --- Helpers ---
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const uid = () => Math.random().toString(36).slice(2);
  const now = () => Date.now();

  // --- Current user (from localStorage.user) fallback
  const userObj = JSON.parse(localStorage.getItem("user") || '{"nickname":"è¨ªå®¢","email":"","avatar":"default-avatar.png","id":"guest"}');
  const userId = userObj.id || 'guest';

  // --- User profiles store (demo)
  const USERS_KEY = "forum_users";
  const DEFAULT_USERS = {
    [userId]: { id:userId, name:userObj.nickname || "è¨ªå®¢", avatar:userObj.avatar || "default-avatar.png", bio:"ä¾†è‡ªé»‘æš—ç«¥è©±çš„è®€è€…ã€‚", topics:1, comments:3, likes:5 },
    "u1": { id:"u1", name:"é»‘å¥³å­©", avatar:"default-avatar.png", bio:"èˆå°é‚Šç·£çš„ä½èªã€‚", topics:2, comments:8, likes:21 },
    "u2": { id:"u2", name:"ç™½å¥³å­©", avatar:"default-avatar.png", bio:"ç«ç´…ç¬‘è²çš„å‚³æ•™å£«ã€‚", topics:1, comments:5, likes:9 }
  };
  const users = JSON.parse(localStorage.getItem(USERS_KEY) || "null") || DEFAULT_USERS;
  localStorage.setItem(USERS_KEY, JSON.stringify(users));

  // --- Threads store (demo data if empty)
  const THREADS_KEY = "forum_threads";
  let threads = [];
  localStorage.setItem(THREADS_KEY, JSON.stringify(threads));

  // --- Follow per-user
  const followKey = (tid)=> `forum_follows_${userId}`;
  const getFollows = ()=> new Set(JSON.parse(localStorage.getItem(followKey()) || "[]"));
  const setFollows = (s)=> localStorage.setItem(followKey(), JSON.stringify(Array.from(s)));

  // --- Last read per thread
  const lastReadKey = (tid)=> `forum_lastRead_${userId}_${tid}`;

  // --- Sort preference
  const PREF_SORT_KEY = `forum_pref_sort_${userId}`;

  // --- Dark mode & font size (reuse if present elsewhere)
  const darkKey = `forum_dark_${userId}`;
  if(localStorage.getItem(darkKey)==="1"){ document.body.classList.add("dark"); }
  // Add toggles near navbar if not present
  const nav = document.querySelector("nav");
  if(nav && !document.getElementById("uiToggles")){
    const span = document.createElement("span");
    span.id = "uiToggles";
    span.style.marginLeft = "10px";
    span.innerHTML = `
      <button class="btn icon" id="darkToggle" style="padding:6px 10px;margin-left:8px;">ğŸŒ™</button>
      <button class="btn icon" id="fontSmaller" style="padding:6px 10px;">A-</button>
      <button class="btn icon" id="fontLarger" style="padding:6px 10px;">A+</button>
    `;
    nav.appendChild(span);
    $("#darkToggle").addEventListener("click", ()=>{
      document.body.classList.toggle("dark");
      localStorage.setItem(darkKey, document.body.classList.contains("dark")?"1":"0");
    });
    $("#fontSmaller").addEventListener("click", ()=>{
      document.documentElement.style.fontSize = (parseFloat(getComputedStyle(document.documentElement).fontSize)-1)+"px";
    });
    $("#fontLarger").addEventListener("click", ()=>{
      document.documentElement.style.fontSize = (parseFloat(getComputedStyle(document.documentElement).fontSize)+1)+"px";
    });
  }

  // --- Render topic list
  const topicListEl = $("#topicList");
  const searchBox = $("#searchBox");
  const sortSel = $("#sortSel");
  const tagOnly = $("#tagOnly");

  sortSel.value = localStorage.getItem(PREF_SORT_KEY) || "latest";
  sortSel.addEventListener("change", ()=>{ localStorage.setItem(PREF_SORT_KEY, sortSel.value); renderTopics(); });

  function sortThreads(arr){
    if(sortSel.value === "likes"){
      return arr.slice().sort((a,b)=> sumLikes(b)-sumLikes(a));
    }else if(sortSel.value === "replies"){
      return arr.slice().sort((a,b)=> countReplies(b)-countReplies(a));
    }
    return arr.slice().sort((a,b)=> b.createdAt - a.createdAt);
  }
  function sumLikes(t){ return t.comments.reduce((s,c)=> s+(c.likes||0), 0); }
  function countReplies(t){ return t.comments.length; }

  function matchesQuery(text, q){
    if(!q) return true;
    return text.toLowerCase().includes(q.toLowerCase());
  }

  function highlight(text, q){
    if(!q) return text;
    return text.replace(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi"), m=> `<mark class="hl">${m}</mark>`);
  }

  function renderTopics(){
    const follows = getFollows();
    const q = searchBox.value.trim();
    const list = sortThreads(threads).filter(t=>{
      const hitTitle = matchesQuery(t.title, q);
      const hitComments = t.comments.some(c=> matchesQuery(c.text, q));
      const tagok = !tagOnly.checked || (t.tags && t.tags.length);
      return (hitTitle || hitComments) && tagok;
    });
    topicListEl.innerHTML = "";
    list.forEach(t=>{
      const lastRead = parseInt(localStorage.getItem(lastReadKey(t.id) ) || "0");
      const hasUnread = t.comments.some(c=> c.createdAt > lastRead);
      const card = document.createElement("div");
      card.className = "topic-card";
      card.innerHTML = `
        <div>
          <div style="font-size:1.05rem;font-weight:bold;">${highlight(t.title, q)} ${hasUnread?'<span class="badge unread">æ–°</span>':''}</div>
          <div class="topic-meta">
            <span>${t.tags.map(tag=>`<span class="badge">${tag}</span>`).join(' ')}</span>
            <span>ç•™è¨€ ${t.comments.length}</span>
            <span>è®š ${sumLikes(t)}</span>
            <span>æ›´æ–° ${timeAgo(Math.max(...t.comments.map(c=>c.createdAt), t.createdAt))}</span>
            ${hasUnread?'<span class="unread-dot"></span>':''}
          </div>
        </div>
        <div>
          <span class="badge ${follows.has(t.id)?'following':''}">${follows.has(t.id)?'å·²è¿½è¹¤':'æœªè¿½è¹¤'}</span>
        </div>
      `;
      card.addEventListener("click", ()=> openThread(t.id));
      topicListEl.appendChild(card);
    });
  }

  searchBox.addEventListener("input", renderTopics);
  tagOnly.addEventListener("change", renderTopics);

  function timeAgo(ts){
    const diff = Math.floor((now()-ts)/1000);
    if(diff<60) return `${diff}s å‰`;
    if(diff<3600) return `${Math.floor(diff/60)}m å‰`;
    if(diff<86400) return `${Math.floor(diff/3600)}h å‰`;
    return `${Math.floor(diff/86400)}d å‰`;
  }

  // --- Thread view
  const threadSection = $("#threadSection");
  const commentsEl = $("#comments");
  const threadTitleEl = $("#threadTitle");
  const threadTagsEl = $("#threadTags");
  const threadMetaEl = $("#threadMeta");
  const followBtn = $("#followBtn");
  const bell = $("#bell");
  const followText = $("#followText");
  const toggleRepliesBtn = $("#toggleReplies");

  let currentThread = null;
  let repliesCollapsed = false;

  function openThread(tid){
    currentThread = threads.find(x=> x.id===tid);
    if(!currentThread) return;
    $("#threadSection").style.display = "block";
    threadTitleEl.textContent = currentThread.title;
    threadTagsEl.innerHTML = (currentThread.tags||[]).map(t=>`<span class="badge">${t}</span>`).join(" ");
    threadMetaEl.innerHTML = `å…± ${currentThread.comments.length} å‰‡ç•™è¨€ Â· ç”± ${new Set(currentThread.comments.map(c=>c.user)).size} äººåƒèˆ‡`;
    updateFollowUI();
    renderComments();
    // mark as read
    localStorage.setItem(lastReadKey(currentThread.id), String(now()));
    renderTopics();
  }

  function updateFollowUI(){
    const follows = getFollows();
    const on = follows.has(currentThread.id);
    bell.classList.toggle("on", on);
    followText.textContent = on ? "å·²è¿½è¹¤" : "è¿½è¹¤";
  }

  followBtn.addEventListener("click", ()=>{
    const s = getFollows();
    if(s.has(currentThread.id)) s.delete(currentThread.id); else s.add(currentThread.id);
    setFollows(s); updateFollowUI(); renderTopics();
  });

  toggleRepliesBtn.addEventListener("click", ()=>{
    repliesCollapsed = !repliesCollapsed;
    toggleRepliesBtn.textContent = repliesCollapsed ? "å±•é–‹å›è¦†" : "æ”¶åˆå›è¦†";
    renderComments();
  });

  // --- Render comments (nested)
  function renderComments(){
    commentsEl.innerHTML = "";
    const root = currentThread.comments.filter(c=>!c.parent);
    const byId = Object.fromEntries(currentThread.comments.map(c=>[c.id,c]));
    const children = {};
    currentThread.comments.forEach(c=>{
      if(c.parent){ (children[c.parent]=children[c.parent]||[]).push(c); }
    });

    // Pinned reply
    if(currentThread.pinnedReply){
      const pr = byId[currentThread.pinnedReply];
      if(pr){
        commentsEl.appendChild(commentNode(pr, true));
      }
    }

    root.forEach(c=>{
      commentsEl.appendChild(commentNode(c, false));
      if(!repliesCollapsed) renderChildren(c.id, 1);
    });

    function renderChildren(pid, depth){
      const kids = children[pid] || [];
      kids.forEach(chi=>{
        const node = commentNode(chi, false, depth);
        commentsEl.appendChild(node);
        if(!repliesCollapsed) renderChildren(chi.id, depth+1);
      });
    }
  }

  function commentNode(c, pinned=false, depth=0){
    const u = users[c.user] || users[userId];
    const wrap = document.createElement("div");
    wrap.className = "comment" + (c.parent? " reply":"");
    wrap.style.marginLeft = c.parent ? (depth*18 + 42) + "px" : "0";

    const emojis = c.emojis || {'â¤ï¸':0,'ğŸ˜‚':0,'ğŸ˜¡':0};
    const created = timeAgo(c.createdAt);

    wrap.innerHTML = `
      <div class="head">
        <img class="avatar" src="${u.avatar}" alt="">
        <div class="name" data-uid="${u.id}">${u.name}</div>
        <div class="meta">${created} ${pinned? 'Â· <span title="ç½®é ‚">ğŸ“Œ ç½®é ‚</span>':''}</div>
      </div>
      <div class="content">${renderRich(c.text)}</div>
      <div class="actions">
        <button data-act="like">ğŸ‘ <span>${c.likes||0}</span></button>
        <div class="emojiRack">
          ${Object.keys(emojis).map(k=>`<button data-emoji="${k}">${k} <span>${emojis[k]||0}</span></button>`).join(' ')}
        </div>
        <button data-act="reply">å›è¦†</button>
        <button data-act="quote">å¼•ç”¨</button>
        ${(c.user===userId)?'<button data-act="edit">ç·¨è¼¯</button><button data-act="del">åˆªé™¤</button>':''}
        ${isAdmin()?'<button data-act="pin">ç½®é ‚</button>':''}
        <button data-act="report">æª¢èˆ‰</button>
      </div>
    `;

    // profile
    wrap.querySelector(".name").addEventListener("click", (e)=> openProfile(e.target.dataset.uid));

    // like
    wrap.querySelector('[data-act="like"]').addEventListener("click", ()=>{
      c.likes = (c.likes||0)+1;
      saveThreads(); renderComments(); burst("+1");
    });

    // emoji
    wrap.querySelectorAll('[data-emoji]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const k = btn.getAttribute("data-emoji");
        c.emojis = c.emojis || {'â¤ï¸':0,'ğŸ˜‚':0,'ğŸ˜¡':0};
        c.emojis[k] = (c.emojis[k]||0)+1;
        saveThreads(); renderComments(); burst(k);
      });
    });

    // reply
    wrap.querySelector('[data-act="reply"]').addEventListener("click", ()=>{
      startReply(c.id, null);
    });

    // quote
    wrap.querySelector('[data-act="quote"]').addEventListener("click", ()=>{
      startReply(c.id, c.text);
    });

    // edit
    if(c.user===userId){
      wrap.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
        const raw = prompt("ç·¨è¼¯ç•™è¨€ï¼š", stripHTML(c.text));
        if(raw!==null){
          c.text = escapeHTML(raw);
          saveThreads(); renderComments();
        }
      });
      wrap.querySelector('[data-act="del"]').addEventListener("click", ()=>{
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç•™è¨€ï¼Ÿ")){
          c.text = "<i>æ­¤ç•™è¨€å·²è¢«åˆªé™¤</i>";
          saveThreads(); renderComments();
        }
      });
    }

    // pin
    if(isAdmin()){
      wrap.querySelector('[data-act="pin"]').addEventListener("click", ()=>{
        currentThread.pinnedReply = (currentThread.pinnedReply===c.id)? null : c.id;
        saveThreads(); renderComments();
      });
    }

    // report
    wrap.querySelector('[data-act="report"]').addEventListener("click", ()=>{
      alert("å·²é€å‡ºæª¢èˆ‰ï¼Œæˆ‘å€‘æœƒç›¡å¿«è™•ç†ã€‚");
    });

    return wrap;
  }

  function isAdmin(){
    // ç°¡å–®åˆ¤å®šï¼šemail å« admin è¦–ç‚ºç®¡ç†å“¡
    return (userObj.email||"").toLowerCase().includes("admin");
  }

  // --- Rich text rendering
  function renderRich(t){
    // very light: support `> quote`, `*bold*`, `_italic_`, and inline code `\`code\``
    let s = t;
    s = escapeHTML(s);
    s = s.replace(/^&gt;\s?(.*)$/gm, '<blockquote>$1</blockquote>');
    s = s.replace(/\*([^*]+)\*/g, '<b>$1</b>');
    s = s.replace(/_([^_]+)_/g, '<i>$1</i>');
    s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
    s = s.replace(/(https?:\/\/\S+)/g, '<a href="$1" target="_blank">$1</a>');
    return s;
  }
  function stripHTML(html){ const div = document.createElement('div'); div.innerHTML = html; return div.textContent || div.innerText || ''; }
  function escapeHTML(str){ return str.replace(/[&<>'"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // --- Start reply with optional quote
  let replyParent = null;
  let quoteText = null;
  const editorBox = $("#editorBox");
  const cancelQuote = $("#cancelQuote");

  function startReply(parentId, qtext){
    replyParent = parentId || null;
    quoteText = qtext || null;
    if(quoteText){
      cancelQuote.style.display = "inline-block";
      // visually show quote inside editor
      const quoted = stripHTML(quoteText).slice(0,160);
      editorBox.innerHTML = `<blockquote style="border-left:3px solid #ff6600;margin:0 0 6px 0;padding-left:8px;color:#555;">${escapeHTML(quoted)}</blockquote>` + editorBox.innerHTML;
    }
    editorBox.focus();
  }
  cancelQuote.addEventListener("click", ()=>{
    quoteText = null; cancelQuote.style.display="none"; editorBox.innerHTML = "";
  });

  // --- Toolbar commands
  $("#emojiBtn").addEventListener("click", (e)=>{
    const panel = $("#emojiPanel");
    if(panel.style.display==="block"){ panel.style.display="none"; return; }
    panel.innerHTML = ["â¤ï¸","ğŸ˜‚","ğŸ˜¡","ğŸ‘","ğŸ”¥","ğŸ‘","ğŸ˜®","ğŸ˜¢"].map(x=>`<button>${x}</button>`).join("");
    panel.style.left = (e.target.getBoundingClientRect().x - 10) + "px";
    panel.style.top = (e.target.getBoundingClientRect().y + 30 + window.scrollY) + "px";
    panel.style.display="block";
    panel.querySelectorAll("button").forEach(b=> b.addEventListener("click", ()=>{
      insertAtCaret(editorBox, b.textContent);
      panel.style.display="none";
    }));
  });
  $$(".tool-btn[data-cmd]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const cmd = btn.dataset.cmd;
      if(cmd==="bold") wrapSelection("**","**");
      else if(cmd==="italic") wrapSelection("_","_");
      else if(cmd==="quote") wrapSelection("> ","");
      else if(cmd==="code") wrapSelection("`","`");
    });
  });

  function insertAtCaret(el, text){
    el.focus();
    document.execCommand('insertText', false, text);
  }
  function wrapSelection(left,right){
    editorBox.focus();
    const sel = window.getSelection();
    if(!sel.rangeCount){ insertAtCaret(editorBox, left+right); return; }
    const range = sel.getRangeAt(0);
    const selected = range.toString();
    document.execCommand('insertText', false, left + selected + right);
  }

  // --- Send comment
  $("#sendBtn").addEventListener("click", ()=>{
    const raw = editorBox.innerText.trim();
    if(!raw){ alert("è«‹è¼¸å…¥å…§å®¹"); return; }
    const txt = quoteText ? `> ${stripHTML(quoteText)}\n\n${raw}` : raw;
    const c = { id: uid(), user: userId, text: txt, createdAt: now(), likes:0, emojis:{'â¤ï¸':0,'ğŸ˜‚':0,'ğŸ˜¡':0}, parent: replyParent };
    currentThread.comments.push(c);
    saveThreads();
    // reset
    replyParent = null; quoteText=null; cancelQuote.style.display="none"; editorBox.innerHTML="";
    renderComments();
    renderTopics();
  });

  function saveThreads(){ localStorage.setItem(THREADS_KEY, JSON.stringify(threads)); }

  // --- Profile modal
  const modal = $("#profileModal");
  $("#profileClose").addEventListener("click", ()=> modal.style.display="none");
  function openProfile(id){
    const u = users[id] || users[userId];
    $("#pfAvatar").src = u.avatar;
    $("#pfName").textContent = u.name;
    $("#pfBio").textContent = u.bio || "";
    $("#pfTopics").textContent = u.topics||0;
    $("#pfComments").textContent = u.comments||0;
    $("#pfLikes").textContent = u.likes||0;
    modal.style.display = "flex";
  }
  modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.style.display="none"; });

  // --- Init render
  renderTopics();
})();
</script>


<!-- user ui block (non-intrusive) -->
<div class="user-right" id="userUIRoot">
  <div id="loginBtn" class="login-text">ç™»å…¥</div>
  <div id="userMenu" class="user-menu" style="display:none;">
    <img id="userAvatar" class="avatar" src="default-avatar.png" alt="é ­åƒ">
  </div>
</div>
<div id="userDropdown" aria-hidden="true">
  <p id="userNickname"></p>
  <p id="userEmail"></p>
  <button class="btn edit-btn" id="editProfileBtn">ç·¨è¼¯å€‹äººè³‡æ–™</button>
  <button class="btn logout-btn" id="logoutBtn">ç™»å‡º</button>
</div>


<script id="user-ui-logic">
(function(){
  function $(id){ return document.getElementById(id); }
  function safe(fn){ try{ fn(); }catch(e){ console.warn(e); } }
  function syncUI(){
    var loginBtn=$('loginBtn'), userMenu=$('userMenu'), avatar=$('userAvatar');
    var nn=$('userNickname'), em=$('userEmail');
    var ustr = localStorage.getItem('user');
    if(ustr){
      try{
        var u = JSON.parse(ustr);
        if(loginBtn) loginBtn.style.display='none';
        if(userMenu) userMenu.style.display='inline-flex';
        if(avatar) avatar.src = u.avatar || 'default-avatar.png';
        if(nn) nn.textContent = 'æš±ç¨±ï¼š' + (u.nickname || '');
        if(em) em.textContent = 'Emailï¼š' + (u.email || '');
      }catch(e){ console.warn('parse user failed', e); }
    }else{
      if(loginBtn) loginBtn.style.display='block';
      if(userMenu) userMenu.style.display='none';
    }
  }

  function bind(){
    var root=$('userUIRoot');
    if(!root){ return false; }
    var loginBtn=$('loginBtn'), userMenu=$('userMenu'), avatar=$('userAvatar');
    var dropdown=$('userDropdown'), logoutBtn=$('logoutBtn'), editBtn=$('editProfileBtn');

    // è¡Œç‚ºï¼šç™»å…¥
    if(loginBtn){
      loginBtn.onclick = function(){ window.location.href='login.html'; };
    }
    // è¡Œç‚ºï¼šé ­åƒ -> å±•é–‹é¸å–®
    if(avatar && dropdown){
      avatar.addEventListener('click', function(ev){
        ev.stopPropagation();
        dropdown.classList.toggle('show');
      });
    }
    // å¤–éƒ¨é»æ“Šæ”¶èµ·
    document.addEventListener('click', function(e){
      var d=$('userDropdown');
      var avatar=$('userAvatar');
      if(!d) return;
      if(d.classList.contains('show')){
        if(!d.contains(e.target) && (!avatar || !avatar.contains(e.target))){
          d.classList.remove('show');
        }
      }
    });

    if(editBtn){
      editBtn.onclick = function(){ window.location.href='data.html'; };
    }
    if(logoutBtn){
      logoutBtn.onclick = function(){
        localStorage.removeItem('user');
        // å…¼å®¹æ—©æœŸå­˜çš„æ——æ¨™
        localStorage.removeItem('loggedIn');
        var d=$('userDropdown'); if(d) d.classList.remove('show');
        syncUI();
      };
    }
    // åˆå§‹åŒæ­¥
    syncUI();
    return true;
  }

  // ç­‰ DOM æº–å‚™å¥½å¾Œç¶å®šï¼›è‹¥æ²’æŠ“åˆ°å…ƒç´ å‰‡è¼ªè©¢
  function init(){
    if(!bind()){
      var t = setInterval(function(){
        if(bind()){ clearInterval(t); }
      }, 120);
    }
  }
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(init, 0);
  }else{
    document.addEventListener('DOMContentLoaded', init);
  }
})();
</script>



<script>
  
</script>



<script>
  
</script>

  <script type="module" src="firebase-init.js"></script>
</body>
</html>
