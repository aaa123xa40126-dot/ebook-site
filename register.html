<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>è¨»å†Š</title>
<style>
:root{--orange:#ff6600;--orange-dark:#cc5200;--bg:#f8f9fa;}
*{box-sizing:border-box;font-family:'æ¨™æ¥·é«”','Times New Roman',serif;}
body{margin:0;background:var(--bg);color:#222;}
.wrap{max-width:460px;margin:40px auto;}
.card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:24px}
h1{text-align:center;margin-bottom:16px}
.field{display:flex;flex-direction:column;margin-bottom:12px;}
input{width:100%;padding:10px;font-size:1rem;border:1px solid #ccc;border-radius:8px;}
.password-field{position:relative;}
.password-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:#666;}
.helper{margin-top:4px;font-size:.85rem}
.helper.ok{color:green}
.helper.warn{color:red}
.strength-bar{height:6px;border-radius:3px;background:#ddd;margin-top:4px;transition:all .3s;}
.strength-weak{background:red;width:33%}
.strength-medium{background:orange;width:66%}
.strength-strong{background:green;width:100%}
.btn{width:100%;padding:12px;background:var(--orange);color:#fff;font-size:1rem;border:none;border-radius:8px;cursor:pointer;}
.btn:hover{background:var(--orange-dark)}
</style>
</head>
<body>
<div class="wrap card">
  <h1>å»ºç«‹å¸³è™Ÿ</h1>
  <div class="field">
    <label for="nickname">æš±ç¨±</label>
    <input id="nickname" type="text" placeholder="è¼¸å…¥æš±ç¨±">
  </div>
  <div class="field">
    <label for="email">Email</label>
    <input id="email" type="email" placeholder="è¼¸å…¥é›»å­éƒµä»¶">
  </div>
  <div class="field password-field">
    <label for="password">å¯†ç¢¼</label>
    <input id="password" type="password" placeholder="è‡³å°‘ 8 ç¢¼ï¼Œå«å¤§å°å¯«èˆ‡æ•¸å­—">
    <span class="password-toggle" onclick="togglePassword('password')">ğŸ‘</span>
    <div id="pwMsg" class="helper"></div>
    <div id="pwStrength" class="strength-bar"></div>
  </div>
  <div class="field password-field">
    <label for="password2">å†æ¬¡è¼¸å…¥å¯†ç¢¼</label>
    <input id="password2" type="password" placeholder="è«‹å†è¼¸å…¥ä¸€æ¬¡å¯†ç¢¼">
    <span class="password-toggle" onclick="togglePassword('password2')">ğŸ‘</span>
    <div id="pw2Msg" class="helper"></div>
  </div>
  <button class="btn" onclick="register()">è¨»å†Š</button>
</div>
<script>
// å…±ç”¨å·¥å…·
function getOrCreateUUID(){let id=localStorage.getItem('deviceUUID');if(!id){id=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));localStorage.setItem('deviceUUID',id);}return id;}
function simpleHash(str){let h=0;for(let i=0;i<str.length;i++){h=Math.imul(31,h)+str.charCodeAt(i)|0;}return (h>>>0).toString(16);}
function getFingerprint(){const ua=navigator.userAgent||'',plat=navigator.platform||'',lang=navigator.language||'';const scr=(screen.width||0)+'x'+(screen.height||0);const uuid=getOrCreateUUID();return simpleHash([ua,plat,lang,scr,uuid].join('|'));}
function readBuyers(){return JSON.parse(localStorage.getItem('allBuyers')||'[]');}
function saveBuyers(arr){localStorage.setItem('allBuyers',JSON.stringify(arr));}
function readDeleted(){return JSON.parse(localStorage.getItem('deletedAccounts')||'[]');}
function readBlockedFP(){return JSON.parse(localStorage.getItem('blockedFingerprints')||'[]');}
const RESERVED=["fire.seed.0000@gmail.com","aaa123xa40126@gmail.com"];

function togglePassword(id){
  const input = document.getElementById(id);
  input.type = (input.type === 'password') ? 'text' : 'password';
}

// å¯†ç¢¼å¼·åº¦æª¢æŸ¥
function checkPasswordStrength(pw){
  const rules={len:pw.length>=8,upper:/[A-Z]/.test(pw),lower:/[a-z]/.test(pw),digit:/[0-9]/.test(pw)};
  const ok=rules.len&&rules.upper&&rules.lower&&rules.digit;
  let score=0;if(rules.len)score++;if(rules.upper)score++;if(rules.lower)score++;if(rules.digit)score++;
  return {ok,score,text:ok?"å¯†ç¢¼å¼·åº¦è‰¯å¥½ âœ…":"ç¼ºå°‘ï¼š"+["é•·åº¦","å¤§å¯«","å°å¯«","æ•¸å­—"].filter((v,i)=>!Object.values(rules)[i]).join("ã€")};
}

document.getElementById('password').addEventListener('input',()=>{
  const pw=document.getElementById('password').value;
  const {ok,score,text}=checkPasswordStrength(pw);
  const msg=document.getElementById('pwMsg');
  msg.textContent=text;msg.className='helper '+(ok?'ok':'warn');
  const bar=document.getElementById('pwStrength');
  bar.className='strength-bar '+(score<=1?'strength-weak':score==2||score==3?'strength-medium':'strength-strong');
});

document.getElementById('password2').addEventListener('input',()=>{
  const p1=document.getElementById('password').value;
  const p2=document.getElementById('password2').value;
  const el=document.getElementById('pw2Msg');
  if(!p2) el.textContent='';
  else if(p1===p2){el.textContent='å…©æ¬¡è¼¸å…¥ä¸€è‡´ âœ…';el.className='helper ok';}
  else {el.textContent='å…©æ¬¡è¼¸å…¥ä¸ä¸€è‡´';el.className='helper warn';}
});

function register(){
  const nickname=document.getElementById('nickname').value.trim();
  const email=document.getElementById('email').value.trim().toLowerCase();
  const password=document.getElementById('password').value;
  const password2=document.getElementById('password2').value;
  if(!nickname||!email||!password){alert('è«‹å®Œæ•´å¡«å¯«');return;}
  const chk=checkPasswordStrength(password);
  if(!chk.ok){alert('å¯†ç¢¼ä¸ç¬¦åˆè¦å‰‡ï¼š'+chk.text);return;}
  if(password!==password2){alert('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´');return;}
  const fp=getFingerprint();
  if(RESERVED.includes(email)){alert('æ­¤ Email ç‚ºç®¡ç†å“¡ä¿ç•™');return;}
  if(readDeleted().includes(email)){alert('æ­¤ Email å·²è¢«å°é–');return;}
  if(readBlockedFP().includes(fp)){alert('æ­¤è£ç½®å·²è¢«å°é–');return;}
  const buyers=readBuyers();
  if(buyers.some(b=>(b.email||'').toLowerCase()===email)){alert('æ­¤ Email å·²è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥');return;}
  const buyer={nickname,email,password,date:new Date().toLocaleString(),blocked:false,blockedUntil:null,blockReason:'',fingerprint:fp,loginHistory:[]};
  buyers.push(buyer);saveBuyers(buyers);
  alert('è¨»å†ŠæˆåŠŸï¼è«‹å‰å¾€ç™»å…¥ã€‚');window.location.href='login.html';
}
</script>
  <script type="module" src="firebase-init.js"></script>

<!-- Firebase Register Integration (no design changes) -->
<script type="module">
import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const auth = getAuth();

function getEl(id){ return document.getElementById(id); }
function showMsg(id, text, ok=false){
  const el = getEl(id);
  if(!el) return;
  el.textContent = text;
  el.className = ok ? 'helper ok' : 'helper warn';
  el.style.display = 'block';
}

// Override global register() if defined via inline onclick
window.register = async function(){
  const nickname = (getEl('nickname')?.value || '').trim();
  const email = (getEl('email')?.value || '').trim();
  const password = getEl('password')?.value || '';
  const password2 = getEl('password2')?.value || '';

  if(!nickname){ showMsg('pwMsg','è«‹è¼¸å…¥æš±ç¨±'); return; }
  if(!email){ showMsg('pwMsg','è«‹è¼¸å…¥é›»å­éƒµä»¶'); return; }
  if(!password || password.length < 6){ showMsg('pwMsg','å¯†ç¢¼è‡³å°‘ 6 ç¢¼'); return; }
  if(password !== password2){ showMsg('pw2Msg','å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´'); return; }

  try{
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    if(nickname){
      try{ await updateProfile(cred.user, { displayName: nickname }); }catch(e){ console.warn('updateProfile failed', e); }
    }
    // è¨»å†Šå®Œæˆ â†’ å›ç™»å…¥é 
    // æ¸…ç†èˆŠ localStorage ä»¥é¿å…èˆŠç¨‹å¼èª¤åˆ¤
    localStorage.removeItem('user'); localStorage.setItem('loggedIn','false');
    window.location.href = 'login.html';
  }catch(err){
    console.error(err);
    // å¸¸è¦‹éŒ¯èª¤è¨Šæ¯è™•ç†
    let msg = 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¢ºèªä¿¡ç®±æ˜¯å¦æ­£ç¢ºæˆ–å·²è¢«ä½¿ç”¨ã€‚';
    if(err.code === 'auth/email-already-in-use') msg = 'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Šã€‚';
    if(err.code === 'auth/invalid-email') msg = 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢ºã€‚';
    if(err.code === 'auth/weak-password') msg = 'å¯†ç¢¼éæ–¼ç°¡å–®ï¼Œè‡³å°‘ 6 ç¢¼ã€‚';
    showMsg('pwMsg', msg);
  }
}
</script>

</body>
</html>
