<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>點燃火種｜封印解除</title>
<meta name="description" content="點燃心之火" />
<style>
  /* ===== 基本設定（不動背景與動畫，只修文字樣式） ===== */
  html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#0a0504;color:#ffe9d6;font-family:"DFKai-SB","Noto Serif TC",serif;}
  #stage{position:fixed;inset:0;z-index:1;}
  .center-ui{
    position:fixed;inset:0;z-index:9;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    text-align:center;pointer-events:none;padding:0 2rem;
  }
  .input-wrap{pointer-events:auto;margin-top:14px}
  input{
    font-family:"DFKai-SB","Noto Serif TC",serif;
    padding:12px 18px;border-radius:12px;
    border:1px solid rgba(255,190,140,.65);
    background:rgba(20,10,5,.78);color:#ffe9d6;
    outline:none;font-size:18px;min-width:340px;text-align:center;
    box-shadow:0 0 14px rgba(255,150,90,.25), inset 0 0 12px rgba(255,170,110,.08);
  }
  input:focus{border-color:#ffb86c;box-shadow:0 0 22px rgba(255,185,110,.45), inset 0 0 14px rgba(255,180,120,.15);}
  button{
    margin-top:22px;pointer-events:auto;font-family:"DFKai-SB","Noto Serif TC",serif;
    border:none;border-radius:14px;padding:.8rem 1.6rem;cursor:pointer;
    background:linear-gradient(180deg,#ffe6cf,#ffd1ab 58%,#ffb170);
    color:#1b0a05;font-size:18px;font-weight:600;
    box-shadow:0 10px 26px rgba(255,120,60,.28), inset 0 0 10px rgba(255,255,255,.25);
    transition:all .25s ease;
  }
  button:hover{transform:translateY(-1px);filter:brightness(1.08);box-shadow:0 14px 34px rgba(255,150,80,.38), inset 0 0 12px rgba(255,255,255,.35);}

  /* ===== 關鍵：與 seal.html 完全一致的文字光暈層次 ===== */
  .seal-wrap{                            /* 和 seal.html 相同的容器 */
    position:relative;pointer-events:auto;text-align:center;margin-bottom:12px;
  }
  .seal-line{                            /* 文字本體 */
    position:relative;z-index:2;
    font-size:clamp(26px,4.8vmin,44px);
    color:#ffe6cf;                       /* 暖橘金 */
    letter-spacing:2px;
    text-shadow:
      0 0 8px rgba(255,180,120,.65),
      0 0 18px rgba(255,150,90,.40),
      0 0 36px rgba(255,140,80,.28);
    animation:breathe 6s ease-in-out infinite;  /* 與 seal 同步的呼吸節奏 */
  }
  /* 兩層外光暈，完全複製 seal 的結構與色階 */
  .seal-wrap::before{
    content:"";position:absolute;inset:-14px -22px;z-index:1;border-radius:26px;
    background:radial-gradient(60% 100% at 50% 50%,rgba(255,210,160,.35),rgba(255,160,90,.16),rgba(255,120,60,.00) 70%);
    filter:blur(10px);
  }
  .seal-wrap::after{
    content:"";position:absolute;inset:-22px -30px;z-index:0;border-radius:30px;
    background:radial-gradient(70% 120% at 50% 50%,rgba(255,220,170,.22),rgba(255,160,90,.12),rgba(255,120,60,.00) 70%);
    filter:blur(16px);animation:breathe 6s ease-in-out infinite;
  }
  @keyframes breathe{0%,100%{opacity:.85}50%{opacity:1.15}}

  /* 白光擴散遮罩（保留原有行為） */
  #whiteout{
    position:fixed;inset:0;z-index:99;pointer-events:none;
    background:radial-gradient(circle at 50% 50%,
      rgba(255,245,235,1) 0%,
      rgba(255,230,190,0.95) 35%,
      rgba(255,200,140,0.75) 55%,
      rgba(255,170,100,0.45) 70%,
      rgba(255,150,80,0.0) 82%);
    clip-path:circle(0px at 50% 50%);
  }
</style>
</head>
<body>
<canvas id="stage"></canvas>

<div class="center-ui">
  <!-- 只替換標題為與 seal.html 相同的結構 -->
  <div class="seal-wrap">
    <div class="seal-line">請輸入您的火種序號</div>
  </div>
  <div class="input-wrap">
    <input id="fireSeed" placeholder="例如：A3F9KZ72XZ">
  </div>
  <button id="igniteBtn">點燃火種</button>
</div>

<div id="whiteout"></div>

<!-- ===== 背景與音效：維持你原本的行為 ===== -->
<script type="module">
import * as THREE from "https://unpkg.com/three@0.152.2/build/three.module.js";

// --- 音效：點一次輸入框開始循環，按鈕按下立刻切換 ---
let startAudio=null, hasStarted=false;
const fireSeed=document.getElementById('fireSeed');
fireSeed.addEventListener('click',()=>{
  if(!hasStarted){
    hasStarted=true;
    startAudio=new Audio('unlock_start.mp3');
    startAudio.loop=true; startAudio.volume=0.9;
    startAudio.play().catch(()=>{});
  }
});

const igniteBtn=document.getElementById('igniteBtn');
let unlocking=false, unlockStart=0;
igniteBtn.addEventListener('click',()=>{
  localStorage.setItem('fire_unlocked', true);
  if(startAudio){try{startAudio.pause();startAudio.currentTime=0;}catch{}}
  const burst=new Audio('unlock_burst.mp3'); burst.volume=1.0; burst.play().catch(()=>{});
  unlocking=true; unlockStart=performance.now();
});

// --- Three.js 背景（與先前一致） ---
const canvas=document.getElementById('stage');
const renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
renderer.setPixelRatio(Math.min(2,window.devicePixelRatio||1));
renderer.setSize(innerWidth,innerHeight);
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,0.1,4000);
camera.position.set(0,0,48);

// 粒子貼圖
function makeTex(){
  const c=document.createElement('canvas');c.width=c.height=128;
  const g=c.getContext('2d');
  const grd=g.createRadialGradient(64,64,0,64,64,64);
  grd.addColorStop(0,'rgba(255,230,180,1)');
  grd.addColorStop(0.4,'rgba(255,180,110,.8)');
  grd.addColorStop(0.7,'rgba(255,150,80,.18)');
  grd.addColorStop(1,'rgba(255,120,50,0)');
  g.fillStyle=grd;g.fillRect(0,0,128,128);
  const t=new THREE.CanvasTexture(c);
  t.minFilter=t.magFilter=THREE.LinearFilter;
  return t;
}
const tex=makeTex();
const world=new THREE.Group();scene.add(world);
const palette=[0xffb06a,0xff8a50,0xff7240,0xffcc7a];
function makeOrbit(r,tx,ty,speed,count,baseOpacity){
  const g=new THREE.Group();g.rotation.set(tx,ty,0);world.add(g);
  const hue=palette[(Math.random()*palette.length)|0];
  const baseMat=new THREE.SpriteMaterial({map:tex,color:hue,blending:THREE.AdditiveBlending,depthWrite:false,transparent:true,opacity:baseOpacity});
  const sprites=[];
  for(let i=0;i<count;i++){
    const a=Math.random()*Math.PI*2;
    const sp=new THREE.Sprite(baseMat.clone());
    sp.scale.setScalar(1.15*(0.7+Math.random()*0.5));
    sp.userData={a,off:Math.random()*6.28,baseOpacity:baseOpacity};
    g.add(sp);sprites.push(sp);
  }
  function update(dt,t){
    g.rotation.z+=speed*dt*0.02;               // 非常緩慢
    for(const s of sprites){
      s.userData.a+=speed*dt*0.12;
      const a=s.userData.a;
      s.position.set(Math.cos(a)*r,Math.sin(a)*r,0);
      s.scale.setScalar(1.15*(1+0.05*Math.sin(t*0.6+s.userData.off)));
    }
  }
  return {update,g,sprites,baseOpacity};
}

const orbits=[
  makeOrbit(13.5,0.25,0.2,0.006,160,0.36),
  makeOrbit(18.0,-0.35,0.6,-0.005,180,0.34),
  makeOrbit(22.8,0.55,-0.15,0.0045,200,0.32),
  makeOrbit(27.4,-0.9,0.45,-0.004,220,0.30),
  makeOrbit(33.6,0.3,0.9,0.0036,220,0.30),
  makeOrbit(39.0,-0.5,-0.8,0.0032,240,0.28),
  makeOrbit(46.0,0.8,0.2,-0.003,260,0.26)
];

// 背景粒子雲
const COUNT=6000;
const geom=new THREE.BufferGeometry();
const pos=new Float32Array(COUNT*3);
const base=new Float32Array(COUNT*3);
for(let i=0;i<COUNT;i++){
  const R=80*Math.random()+30;
  const th=Math.random()*Math.PI*2;
  const ph=Math.acos(2*Math.random()-1);
  const x=R*Math.sin(ph)*Math.cos(th);
  const y=R*Math.sin(ph)*Math.sin(th);
  const z=R*Math.cos(ph);
  pos[i*3]=x; pos[i*3+1]=y; pos[i*3+2]=z;
  base[i*3]=x; base[i*3+1]=y; base[i*3+2]=z;
}
geom.setAttribute('position',new THREE.BufferAttribute(pos,3));
const pMat=new THREE.PointsMaterial({size:0.55,map:tex,color:0xffb06a,transparent:true,opacity:0.45,depthWrite:false,blending:THREE.AdditiveBlending});
const particles=new THREE.Points(geom,pMat);scene.add(particles);

// 滑鼠吸引
let mx=0,my=0;
window.addEventListener('pointermove',e=>{mx=(e.clientX/innerWidth)*2-1;my=-(e.clientY/innerHeight)*2+1;},{passive:true});
const ray=new THREE.Raycaster();const plane=new THREE.Plane(new THREE.Vector3(0,0,1),0);const worldPt=new THREE.Vector3();
function updateParticles(dt, attractPoint){
  const arr=geom.attributes.position.array;
  for(let i=0;i<COUNT;i++){
    const ix=i*3; let x=arr[ix],y=arr[ix+1],z=arr[ix+2];
    const bx=base[ix],by=base[ix+1],bz=base[ix+2];
    x+=(bx-x)*0.0005*dt; y+=(by-y)*0.0005*dt; z+=(bz-z)*0.0005*dt;
    if(attractPoint){
      const dx=attractPoint.x-x, dy=attractPoint.y-y, dz=attractPoint.z-z;
      const dist=Math.hypot(dx,dy,dz)+0.0001;
      if(dist<22){const f=(22-dist)/22; x+=dx*f*0.05*dt; y+=dy*f*0.05*dt; z+=dz*f*0.05*dt;}
    }
    const ang=0.0006*dt,cs=Math.cos(ang),sn=Math.sin(ang);
    const nx=x*cs+z*sn,nz=-x*sn+z*cs;
    arr[ix]=nx; arr[ix+1]=y; arr[ix+2]=nz;
  }
  geom.attributes.position.needsUpdate=true;
}

// 主循環
let last=performance.now();
function tick(){
  const now=performance.now(),dt=Math.min(60,now-last)/16.6667;last=now;
  const t=now/1000;
  if(!unlocking){
    world.rotation.y+=0.0006*dt;
    for(const o of orbits)o.update(dt,t);
    pMat.opacity=0.42+0.06*Math.sin(t*0.7);
    ray.setFromCamera({x:mx,y:my},camera);
    ray.ray.intersectPlane(plane,worldPt);
    updateParticles(dt,worldPt);
  }else{
    const elapsed=now-unlockStart;
    const ringTotal=5500,whiteDuration=2000; // 7.5秒
    const perRingDelay=ringTotal/orbits.length;
    const singleFade=perRingDelay*0.75;
    orbits.forEach((o,i)=>{
      const start=i*perRingDelay;
      let mul=1.0;
      if(elapsed>=start){
        const k=Math.min(1,(elapsed-start)/singleFade);
        mul=Math.pow(1-k,1.6);
      }
      o.g.children.forEach(s=>s.material.opacity=s.userData?.baseOpacity? s.userData.baseOpacity*mul:(s.material.opacity=mul*0.3));
    });
    const particleMul=elapsed<ringTotal?1:Math.max(0,1-(elapsed-ringTotal)/whiteDuration);
    pMat.opacity=0.45*particleMul;
    if(elapsed>ringTotal){ expandWhiteFromCenter(Math.min(1,(elapsed-ringTotal)/whiteDuration)); }
    if(elapsed>=ringTotal+whiteDuration){ window.location.href='main.html'; return; }
  }
  renderer.render(scene,camera);
  requestAnimationFrame(tick);
}
tick();

// 白光擴散
const whiteout=document.getElementById('whiteout');
function expandWhiteFromCenter(p){
  const diag=Math.hypot(innerWidth,innerHeight);
  const r=diag*(0.04+0.96*p);
  whiteout.style.clipPath=`circle(${r}px at 50% 50%)`;
}
</script>
</body>
</html>
